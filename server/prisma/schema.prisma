datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              Int       @id @default(autoincrement())
  username        String    @unique
  name            String    @default("")
  password        String
  bio             String    @default("")
  createdAt       DateTime  @default(now())
  profilePicture  String?

  friends         User[]    @relation("UserFriends")
  friendOf        User[]    @relation("UserFriends")

  sentRequests    FriendRequest[] @relation("FriendshipRequester")
  receivedRequests FriendRequest[] @relation("FriendshipReceiver")

  posts           Post[]    @relation("PostAuthor")
  comments        Comment[] @relation("CommentAuthor")

  chats1          Chat[]    @relation("ChatParticipant1")
  chats2          Chat[]    @relation("ChatParticipant2")
  sentMessages    Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")
  postsLiked      Post[]    @relation("WhoLiked")

  messagesRead    MessageRead[]
}

model FriendRequest {
  id          Int @id @default(autoincrement())
  requesterId Int
  receiverId  Int

  requester User @relation("FriendshipRequester", fields: [requesterId], references: [id])
  receiver  User @relation("FriendshipReceiver", fields: [receiverId], references: [id])

  @@unique([requesterId, receiverId])
}

model Post {
  id        Int      @id @default(autoincrement())
  authorId  Int
  content   String
  likes     User[]   @relation("WhoLiked")
  createdAt DateTime @default(now())

  author   User      @relation("PostAuthor", fields: [authorId], references: [id])
  comments Comment[] @relation("CommentPost")
}

model Comment {
  id        Int      @id @default(autoincrement())
  authorId  Int
  postId    Int
  parentId  Int?
  text      String
  createdAt DateTime @default(now())

  author  User      @relation("CommentAuthor", fields: [authorId], references: [id])
  post    Post      @relation("CommentPost", fields: [postId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")
}

model Chat {
  id             Int      @id @default(autoincrement())
  participant1Id Int
  participant2Id Int
  createdAt      DateTime @default(now())
  lastMessageId  Int?     @unique

  participant1 User      @relation("ChatParticipant1", fields: [participant1Id], references: [id])
  participant2 User      @relation("ChatParticipant2", fields: [participant2Id], references: [id])
  messages     Message[] @relation("MessageChat")
  lastMessage  Message?  @relation("LastMessage", fields: [lastMessageId], references: [id])

  @@unique([participant1Id, participant2Id])
}

model Message {
  id         Int      @id @default(autoincrement())
  chatId     Int
  senderId   Int
  receiverId Int
  content    String
  sentAt     DateTime @default(now())

  chat       Chat     @relation("MessageChat", fields: [chatId], references: [id])
  sender     User     @relation("MessageSender", fields: [senderId], references: [id])
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  chatLast   Chat?    @relation("LastMessage")

  readers    MessageRead[]
}

model MessageRead {
  id         Int      @id @default(autoincrement())
  userId     Int
  messageId  Int
  readAt     DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])
  message    Message  @relation(fields: [messageId], references: [id])

  @@unique([userId, messageId])
}
